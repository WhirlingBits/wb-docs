image: node:20-bullseye

stages:
  - fetch
  - build

variables:
  DOC_REPO_DIR: wb-idf-core

# 1ï¸âƒ£ Repo mit Quellcode klonen
fetch_repo:
  stage: fetch
  image: node:20-bullseye
  variables:
    GIT_STRATEGY: none
  script:
    - apt-get update && apt-get install -y git
    - git clone https://matti122:${GITHUB_TOKEN}@github.com/WhirlingBits/wb-idf-core.git $DOC_REPO_DIR
  artifacts:
    paths:
      - $DOC_REPO_DIR/doxygen/xml

# 2ï¸âƒ£ Doxygen ausfÃ¼hren und MDX generieren
build_doxygen2docusaurus:
  stage: build
  dependencies:
    - fetch_repo
  script:
    # ğŸ§© Dependencies installieren
    - apt-get update && apt-get install -y doxygen graphviz
    - npm install -g @xpack/doxygen2docusaurus@latest --save-dev

    # ğŸ§± In das geklonte Repo wechseln und Doxygen ausfÃ¼hren
    - cd $DOC_REPO_DIR
    - mkdir -p doxygen/xml
    - doxygen Doxyfile

    # âœ… Ergebnis prÃ¼fen
    - ls -R doxygen/xml

    # ğŸ” ZurÃ¼ck ins Dokumentations-Repo (wb-docs)
    - cd ../
    - ls -R

    # ğŸ§© XML â†’ MDX konvertieren (mit absoluten Pfaden)
    - npx doxygen2docusaurus --input wb-idf-core/doxygen/xml --output docs/mdx

    # âœ… Ergebnis prÃ¼fen
    - ls -R docs/mdx

  artifacts:
    paths:
      - docs/mdx
